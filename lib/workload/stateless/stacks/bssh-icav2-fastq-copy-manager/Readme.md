# BSSH Manager

<!-- TOC -->
* [BSSH Manager](#bssh-manager)
  * [Overview](#overview)
  * [Inputs](#inputs)
  * [Outputs](#outputs)
  * [Lambdas in this directory](#lambdas-in-this-directory)
    * [Process BCLConvert Output](#process-bclconvert-output)
  * [SSM Parameters](#ssm-parameters-)
    * [Parameters generated by CDK](#parameters-generated-by-cdk)
    * [External Parameters required by CDK](#external-parameters-required-by-cdk)
<!-- TOC -->

## Overview

The bssh manager runs performs the following logic:

Reads the bssh_output.json file from the BCLConvert run output folder

* Collects the basespace run id from the bssh output json

* Collects the run id from the run info xml

* Collects the fastq list csv file from the BCLConvert run output folder

* Read and return the fastq list rows as a list of dictionaries (gzip compressed / b64 encoded)

* Collects the samplesheet path from the BCLConvert run output folder (as we might need this to go into the cttso directories)

* Read and return the samplesheet as a dictionary (via the v2-samplesheet-maker package) (gzip compressed / b64 encoded)

* Return a manifest of icav2 uris where each key represents a ICAv2 data uri (file) and the value is a list of icav2 uris where each uri is a destination for a given file.

![](./images/step_functions_image.png)

## Inputs

* Statemachine expects the following inputs:
  * project_id (the project in which BCLConvert was run), 
  * analysis_id (the analysis id), and a 
  * portal_run_id (a unique identifier to provide a unique location for the outputs)

An example is below

```json
{
  "project_id": "b23fb516-d852-4985-adcc-831c12e8cd22",
  "analysis_id": "544654e7-c198-466f-b981-44b5364ee4d8",
  "portal_run_id": "20240307abcd7890"
}
```

## Outputs

```json5
{
  "outputs": {
    "run_id": "231116_A01052_0172_BHVLM5DSX7",
    "icav2_copy_utility_job_execution_id": "arn:aws:states:ap-southeast-2:843407916570:execution:icav2copybatchstatemachine5CF33BCC-keqBru6FYvUB:604a2bc9-c641-4842-ac4c-00a1ddd4e98d",
    "output_uri": "icav2://7595e8f2-32d3-4c76-a324-c6a85dae87b5/ilmn_primary/2023/231116_A01052_0172_BHVLM5DSX7/3661659/20240307abcd7890/",
    "manifest_b64gz": "H4sIALln6WUC/+2cX2/bNhTFv0rR58kSL/W3b03argESpI3SdcAwELTE2NpkyaPoNNmw7z7GrZlmy9Y2GW2Tuk85BoqE/N3jcy8tun88bSp+Cc/CcAr0YpqQNKjzBIK4yJOA11UV5JRUBERe1QBh0y66gHe8vR7EEAIlhKTseUSiBFhEMmAHr384PklelD9mrIY4TQiLqyKqq+Cgag/77lJI9eQyZsCyYJqRosrrIkhEWus/KNKA51MRVJxk00QUdRxNw36llisVHvezIXzFB/XbYb9YtkKJibpST589+cmsP0uKROQXEFCoaRBXmf51FOKgSnme1Fzk+peu18+WsllweR1CBPS/9xDSNCVpUtz80ziiUcanVZ3lRfRxQU9//u6JQ/zec9k13WyYtP0M0X0TupdS9hLBfRO4M7HspRrC5zVfKiHZiVCyqYZJNVzuEOJmVY4Z8Ki76NF+D7HfC7FYtarRTeOKlYorNOBDSb5d8bZR1/hGfiTHo67WXnzdL5e6G7PDftWhKR/dXQ6vq1agNR9Js+Q303U5F0IhwwcyPFt16259tWiR3wP4Xdwc81jbDGjBR3WYT1l4ulKTadMhxwdwPO+X7F33a9d/6NgBl1VfC+wt/8cgft7oZo3T+GNwyvXPyVxhm3nUaWZtRZwbHwbz47w4hMe8E4yEx0AjQrNbwcqYHUcRYWeE6R+TdW+fzH7fIeR/W7KP0AGh24UeGcFK6gb0yEvoBKHbhQ5GsDJxAzp4CR0QulXoaWEEK8EJp+sluw49N4KVxA3ouZfQAaFvP14A48US9HddLZSQi6YT9Z0XrIz2PGbuLN3nAgAWwFoBNhNknDIp5Kr720tWZjdFgH19F/xj+b6XAbAM2zhYUSNYmbpxmqXOe7+46/1i430SuZFBhScZlN2tQ7apQ+5GGTI/ypAlRui3AHWCvV6zl9QBqe84+gGjfx+iHzD6t1CGPDFCvwViJ6I/T/ykDkh9+0ctwKOWXatnRmirJ24ETOZ8d83vdtd8010LNw5WuSfd9V7zA5rfCvVNvOe5EZr6+uNMuq+O/2zNXlIHpL7boAcM+m2YPzVCmz91I3JSP6kDUrcUOV96gL7Hc6UfD9C/ogCABbDedJPoTtPdvNQZRJw4Xpn1e18HwDps40lWbIRmD248P4z9pA5I3erMWRAjWAmRE5N+QZynnhihqVM3qCd+UgekvoOEAUwYu9QjI3Q3LdxImMhP6oDUrVDfDIxAjNAJs75+EO+r1z9bs7Ne/9LHNnscND58bPNVBQAswI5yBzB37FIHIzT1xI20B+epUyM09dQN6tRPrwN6fQdeB/S6Xeq3QlPP3EiY2E/qgNTtUk+M0NRzN7ye+EkdkLrdW02FEawkuRt3yQrnvZ4aob1euJEwqZ/UAanbpZ4ZwUoaueH1zM9cB8z1HXgd0Ot2qedGaOrEjYTJ/aQOSN0u9cIITR3c8HrhJ3VA6lapUzBCU3fjWRIFP6kDUrdLPTJCU6dueD3ykzogdbvUiRGauhs3wijxkzogdbvUqRGauhs3Myj1kzogdbvUb4Wm7sYdARr7SR2Qul3qiRGauht3BGjiJ3VA6lapx7dCU3fjaXUc+0kdkLrd74jdClYCuPHNPOo8dTBCUyduUAc/vQ7o9R14HdDrlrrpl76Ot8ejjB9fx/uKAgAWwPo8ec//9LD3U3xB/KQOSN0u9VvBytgRr8d+UgekbpX6PTd9997r7t/0vZ86eEpdrrohnA7DnPHlAMEwD5ayr9nmzx91ekg6XYbP22bWLUSnToSSTTWcrtRk2nQ75LBZmd19v1wsG71f3r6Z86HpZiPb/mEvpaiUqI9GV/kDPghd93Z8RX8pZS/HtucrJfSJsD5vWjGyrZ8u1U3AnfS1aEe29bef9ntwfdNNR+R1ySvV9N3Iyv3m1feyqUe26aMFn40t0kaY4hWv5iKsxQVftaqac6mGyS9Dvw8b/7i07SQ56BWMpeSv3r8+GWGgvR3baHo5vmP3mZg1g55SRjikHOljyNUe7vnPvwDRloHxWK8AAA==",  // pragma: allowlist secret 
    "fastq_list_rows_b64gz": "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", // pragma: allowlist secret
    "samplesheet_b64gz": "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",  // pragma: allowlist secret
    "basespace_run_id": 3661659
  }
}
```

## Lambdas in this directory

All lambdas run on python 3.11 or higher.

### Process BCLConvert Output

1. Get the output directory of the underlying BCLConvert run
2. Collect the bssh_output.json file from the BCLConvert run output folder
3. Collect the basespace run id from the bssh output json
4. Collect the run id from the run info xml
5. Collect the fastq list csv file from the BCLConvert run output folder

The step function then completes by submitting an event with the manifest as the payload

## SSM Parameters 

### Parameters generated by CDK

```
BSSH_ICAV2_FASTQ_COPY_STATE_MACHINE_ARN_SSM_PARAMETER_PATH  # "/bssh_icav2_fastq_copy/state_machine_arn"
```

### External Parameters required by CDK

```
/icav2/umccr-prod/service-user-trial-jwt-token-secret-arn
/icav2/umccr-prod/cache_project_id
/icav2/umccr-prod/cache_project_bclconvert_output_path
/icav2_copy_batch_utility/state_machine_arn_batch
```


