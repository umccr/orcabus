{
  "Comment": "A description of my state machine",
  "StartAt": "Move Inputs",
  "States": {
    "Move Inputs": {
      "Type": "Pass",
      "Next": "Translate event",
      "Parameters": {
        "inputs.$": "$"
      }
    },
    "Translate event": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "Payload.$": "$"
      },
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException",
            "Lambda.TooManyRequestsException"
          ],
          "IntervalSeconds": 1,
          "MaxAttempts": 3,
          "BackoffRate": 2
        }
      ],
      "Next": "Update Database",
      "ResultSelector": {
        "subject_id.$": "$.Payload.subject_id",
        "library_id.$": "$.Payload.library_id",
        "library_runs.$": "$.Payload.library_runs"
      },
      "ResultPath": "$.get_input_event_data_step"
    },
    "Update Database": {
      "Type": "Parallel",
      "End": true,
      "Branches": [
        {
          "StartAt": "Get Subject from Database",
          "States": {
            "Get Subject from Database": {
              "Type": "Task",
              "Resource": "arn:aws:states:::dynamodb:getItem",
              "Parameters": {
                "TableName": "MyDynamoDBTable",
                "Key": {
                  "Column": {
                    "S": "MyEntry"
                  }
                }
              },
              "Next": "Check Subject In Database"
            },
            "Check Subject In Database": {
              "Type": "Choice",
              "Choices": [
                {
                  "Next": "Subject In DataBase"
                }
              ],
              "Default": "Initialise Subject in DB"
            },
            "Subject In DataBase": {
              "Type": "Pass",
              "Next": "Check Library In Subject",
              "ResultPath": null
            },
            "Check Library In Subject": {
              "Type": "Choice",
              "Choices": [
                {
                  "Next": "Append Library to Subject"
                }
              ],
              "Default": "Library Already In Subject"
            },
            "Append Library to Subject": {
              "Type": "Task",
              "Resource": "arn:aws:states:::dynamodb:updateItem",
              "Parameters": {
                "TableName": "${__table_name__}",
                "Key": {
                  "Column": {
                    "S": "MyEntry"
                  }
                },
                "UpdateExpression": "SET MyKey = :myValueRef",
                "ExpressionAttributeValues": {
                  ":myValueRef": {
                    "S": "MyValue"
                  }
                }
              },
              "End": true
            },
            "Library Already In Subject": {
              "Type": "Pass",
              "End": true,
              "ResultPath": null
            },
            "Initialise Subject in DB": {
              "Type": "Task",
              "Resource": "arn:aws:states:::dynamodb:putItem",
              "Parameters": {
                "TableName": "${__table_name__}",
                "Item": {
                  "Column": {
                    "S": "MyEntry"
                  }
                }
              },
              "End": true
            }
          }
        },
        {
          "StartAt": "Add library runs",
          "States": {
            "Add library runs": {
              "Type": "Map",
              "ItemProcessor": {
                "ProcessorConfig": {
                  "Mode": "INLINE"
                },
                "StartAt": "Add library run to database",
                "States": {
                  "Add library run to database": {
                    "Type": "Task",
                    "Resource": "arn:aws:states:::dynamodb:putItem",
                    "Parameters": {
                      "TableName": "${__table_name__}",
                      "Item": {
                        "Column": {
                          "S": "MyEntry"
                        }
                      }
                    },
                    "End": true
                  }
                }
              },
              "End": true,
              "ItemsPath": "$.get_input_event_data_step.library_runs"
            }
          }
        },
        {
          "StartAt": "Get Library from Database",
          "States": {
            "Get Library from Database": {
              "Type": "Task",
              "Resource": "arn:aws:states:::dynamodb:getItem",
              "Parameters": {
                "TableName": "MyDynamoDBTable",
                "Key": {
                  "Column": {
                    "S": "MyEntry"
                  }
                }
              },
              "Next": "Check Library In Database"
            },
            "Check Library In Database": {
              "Type": "Choice",
              "Choices": [
                {
                  "Next": "Add Library to Database"
                }
              ],
              "Default": "Append libraryruns to library"
            },
            "Append libraryruns to library": {
              "Type": "Task",
              "Resource": "arn:aws:states:::dynamodb:updateItem",
              "Parameters": {
                "TableName": "${__table_name__}",
                "Key": {
                  "Column": {
                    "S": "MyEntry"
                  }
                },
                "UpdateExpression": "SET MyKey = :myValueRef",
                "ExpressionAttributeValues": {
                  ":myValueRef": {
                    "S": "MyValue"
                  }
                }
              },
              "End": true
            },
            "Add Library to Database": {
              "Type": "Task",
              "Resource": "arn:aws:states:::dynamodb:putItem",
              "Parameters": {
                "TableName": "${__table_name__}",
                "Item": {
                  "Column": {
                    "S": "MyEntry"
                  }
                }
              },
              "End": true
            }
          }
        }
      ]
    }
  }
}
